#include "base58.h"

static const CHAR g_Base58Map[256] =
{
	-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
	-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
	-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
	-1,  0,  1,  2,  3,  4,  5,  6,  7,  8, -1, -1, -1, -1, -1, -1,
	-1,  9, 10, 11, 12, 13, 14, 15, 16, -1, 17, 18, 19, 20, 21, -1,
	22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, -1, -1, -1, -1, -1,
	-1, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, -1, 44, 45, 46,
	47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, -1, -1, -1, -1, -1,
	-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
	-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
	-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
	-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
	-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
	-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
	-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
	-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
};

// DWORD => SIZE_T.
DWORD Base58Decode(PCSTR pData, PBYTE pbBuf, DWORD dwSize)
{
	INT Len,
		Res,
		i,
		Carry,
		j,
		Tmp;

	Len		 = lstrlenA(pData);
	Res		 = 0;
	pbBuf[0] = 0x00;

	// 1:1 is the minimum when all encoded bytes are 0.
	if (dwSize < (DWORD)Len)
		return 0;

	for (i = 0; i < Len; ++i)
	{
		Carry = g_Base58Map[pData[i]];

		if (Carry == -1)
			return 0;

		for (j = 0; j < Res; ++j)
		{
			Carry	+= pbBuf[j] * 58;
			pbBuf[j] = Carry	& 0xFF;
			Carry  >>= 8;
		}

		while (Carry > 0)
		{
			pbBuf[Res++] = Carry & 0xFF;
			Carry	   >>= 8;
		}
	}

	for (i = 0; i < Len && pData[i] == '1'; ++i)
	{
		pbBuf[Res++] = 0x00;
	}

	for (i = 0; i < Res / 2; ++i)
	{
		Tmp				   = pbBuf[i];
		pbBuf[i]		   = pbBuf[Res - i - 1];
		pbBuf[Res - i - 1] = Tmp;
	}

	return Res;
}
